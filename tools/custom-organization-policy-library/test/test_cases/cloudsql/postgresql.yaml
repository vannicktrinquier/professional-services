# cloudsql_postgresql_instance_allowed:
#   steps:
#   - identifier: "{{ prefix }}-cloudsql-postgresql-allowed"
#     command: >- 
#       gcloud sql instances create {{ identifier }}
#       --availability-type=REGIONAL 
#       --region=asia-southeast2 
#       --tier=db-g1-small 
#       --database-version=POSTGRES_15 
#       --enable-point-in-time-recovery
#       --root-password=R00tP@ss0rd11@@ 
#       --enable-password-policy 
#       --password-policy-min-length=12 
#       --password-policy-complexity=COMPLEXITY_DEFAULT  
#       --backup-location=asia-southeast1 
#       --retained-backups-count=10 
#       --storage-type=SSD    
#       --ssl-mode=ENCRYPTED_ONLY
#       --database-flags=log_connections=on,log_disconnections=on,log_min_messages=warning,log_min_error_statement=error,log_min_duration_statement=-1,cloudsql.enable_pgaudit=on,log_error_verbosity=default,log_statement=ddl
#     expected_return_code: 0
#     teardown_command: gcloud sql instances delete {{ idenfifier }}
#   markers:
#     - cloudsql
#     - postgresql
cloudsql_postgresql_instance_no_ssl_mode_encrypted:
  steps:
  - identifier: "{{ prefix }}-cloudsql-postgresql-no-ssl-mode"
    command: >- 
      gcloud sql instances create {{ identifier }}
      --availability-type=REGIONAL 
      --region=asia-southeast2 
      --tier=db-g1-small 
      --database-version=POSTGRES_15 
      --enable-point-in-time-recovery
      --root-password=R00tP@ss0rd11@@ 
      --enable-password-policy 
      --password-policy-min-length=12 
      --password-policy-complexity=COMPLEXITY_DEFAULT  
      --backup-location=asia-southeast1 
      --retained-backups-count=10 
      --storage-type=SSD      
      --database-flags=local_infile=off,local_infile=off
    expected_return_code: 1
    expected_stderr: "customConstraints/custom.cloudsqlRequireSSLConnection"
    teardown_command: gcloud sql instances delete {{ idenfifier }}
  markers:
    - cloudsql
    - postgresql
cloudsql_postgresql_instance_no_public_authorized_networks:
  steps:
  - identifier: "{{ prefix }}-cloudsql-postgresql-no-public-authorized-networks"
    command: >- 
      gcloud sql instances create {{ identifier }}
      --availability-type=REGIONAL 
      --region=asia-southeast2 
      --tier=db-g1-small 
      --database-version=POSTGRES_15 
      --enable-point-in-time-recovery
      --root-password=R00tP@ss0rd11@@ 
      --enable-password-policy 
      --password-policy-min-length=12 
      --password-policy-complexity=COMPLEXITY_DEFAULT  
      --backup-location=asia-southeast1 
      --retained-backups-count=10 
      --storage-type=SSD     
      --database-flags=local_infile=off,local_infile=off
      --ssl-mode=ENCRYPTED_ONLY 
      --authorized-networks=0.0.0.0/0
    expected_return_code: 1
    expected_stderr: "customConstraints/custom.cloudsqlDisablePublicAuthorizedNetworks"
    teardown_command: gcloud sql instances delete {{ idenfifier }}
  markers:
    - cloudsql
    - postgresql
cloudsql_postgresql_instance_no_backup:
  steps:
  - identifier: "{{ prefix }}-cloudsql-postgresql-no-backup"
    command: >- 
      gcloud sql instances create {{ identifier }}
      --availability-type=REGIONAL 
      --region=asia-southeast2 
      --tier=db-g1-small 
      --database-version=POSTGRES_15 
      --root-password=R00tP@ss0rd11@@ 
      --enable-password-policy 
      --password-policy-min-length=12 
      --password-policy-complexity=COMPLEXITY_DEFAULT  
      --storage-type=SSD    
      --database-flags=local_infile=off,local_infile=off
      --ssl-mode=ENCRYPTED_ONLY
    expected_return_code: 1
    expected_stderr: "customConstraints/custom.cloudsqlRequireAutomatedBackup"
    teardown_command: gcloud sql instances delete {{ idenfifier }}
  markers:
    - cloudsql
    - postgresql
cloudsql_postgresql_instance_no_log_connections_on_flag:
  steps:
  - identifier: "{{ prefix }}-cloudsql-postgresql-no-log-connections-on-flag"
    command: >- 
      gcloud sql instances create {{ identifier }}
      --availability-type=REGIONAL 
      --region=asia-southeast2 
      --tier=db-g1-small 
      --database-version=POSTGRES_15 
      --enable-point-in-time-recovery
      --root-password=R00tP@ss0rd11@@ 
      --enable-password-policy 
      --password-policy-min-length=12 
      --password-policy-complexity=COMPLEXITY_DEFAULT  
      --backup-location=asia-southeast1 
      --retained-backups-count=10 
      --storage-type=SSD    
      --database-flags=local_infile=off,local_infile=off
      --ssl-mode=ENCRYPTED_ONLY
      --database-flags=log_connections=off,log_disconnections=on,log_min_messages=warning,log_min_error_statement=error,log_min_duration_statement=-1,cloudsql.enable_pgaudit=on,log_error_verbosity=default,log_statement=ddl
    expected_return_code: 1
    expected_stderr: "customConstraints/custom.cloudsqlRequirePostgreSQLDatabaseFlags"
    teardown_command: gcloud sql instances delete {{ idenfifier }}
  markers:
    - cloudsql
    - postgresql
cloudsql_postgresql_instance_no_log_discconnections_on_flag:
  steps:
  - identifier: "{{ prefix }}-cloudsql-postgresql-no-log-disconnections-on-flag"
    command: >- 
      gcloud sql instances create {{ identifier }}
      --availability-type=REGIONAL 
      --region=asia-southeast2 
      --tier=db-g1-small 
      --database-version=POSTGRES_15 
      --enable-point-in-time-recovery
      --root-password=R00tP@ss0rd11@@ 
      --enable-password-policy 
      --password-policy-min-length=12 
      --password-policy-complexity=COMPLEXITY_DEFAULT  
      --backup-location=asia-southeast1 
      --retained-backups-count=10 
      --storage-type=SSD    
      --database-flags=local_infile=off,local_infile=off
      --ssl-mode=ENCRYPTED_ONLY
      --database-flags=log_connections=on,log_disconnections=off,log_min_messages=warning,log_min_error_statement=error,log_min_duration_statement=-1,cloudsql.enable_pgaudit=on,log_error_verbosity=default,log_statement=ddl
    expected_return_code: 1
    expected_stderr: "customConstraints/custom.cloudsqlRequirePostgreSQLDatabaseFlags"
    teardown_command: gcloud sql instances delete {{ idenfifier }}
  markers:
    - cloudsql
    - postgresql
cloudsql_postgresql_instance_log_min_messages_error:
  steps:
  - identifier: "{{ prefix }}-cloudsql-postgresql-log-min-messages-error"
    command: >- 
      gcloud sql instances create {{ identifier }}
      --availability-type=REGIONAL 
      --region=asia-southeast2 
      --tier=db-g1-small 
      --database-version=POSTGRES_15 
      --enable-point-in-time-recovery
      --root-password=R00tP@ss0rd11@@ 
      --enable-password-policy 
      --password-policy-min-length=12 
      --password-policy-complexity=COMPLEXITY_DEFAULT  
      --backup-location=asia-southeast1 
      --retained-backups-count=10 
      --storage-type=SSD    
      --database-flags=local_infile=off,local_infile=off
      --ssl-mode=ENCRYPTED_ONLY
      --database-flags=log_connections=on,log_disconnections=on,log_min_messages=error,log_min_error_statement=error,log_min_duration_statement=-1,cloudsql.enable_pgaudit=on,log_error_verbosity=default,log_statement=ddl
    expected_return_code: 1
    expected_stderr: "customConstraints/custom.cloudsqlRequirePostgreSQLDatabaseFlags"
    teardown_command: gcloud sql instances delete {{ idenfifier }}
  markers:
    - cloudsql
    - postgresql
cloudsql_postgresql_instance_log_min_error_statement_fatal:
  steps:
  - identifier: "{{ prefix }}-cloudsql-postgresql-log-min-error-statement-fatal"
    command: >- 
      gcloud sql instances create {{ identifier }}
      --availability-type=REGIONAL 
      --region=asia-southeast2 
      --tier=db-g1-small 
      --database-version=POSTGRES_15 
      --enable-point-in-time-recovery
      --root-password=R00tP@ss0rd11@@ 
      --enable-password-policy 
      --password-policy-min-length=12 
      --password-policy-complexity=COMPLEXITY_DEFAULT  
      --backup-location=asia-southeast1 
      --retained-backups-count=10 
      --storage-type=SSD    
      --ssl-mode=ENCRYPTED_ONLY
      --database-flags=log_connections=on,log_disconnections=on,log_min_messages=warning,log_min_error_statement=fatal,log_min_duration_statement=-1,cloudsql.enable_pgaudit=on,log_error_verbosity=default,log_statement=ddl
    expected_return_code: 1
    expected_stderr: "customConstraints/custom.cloudsqlRequirePostgreSQLDatabaseFlags"
    teardown_command: gcloud sql instances delete {{ idenfifier }}
  markers:
    - cloudsql
    - postgresql
cloudsql_postgresql_instance_wrong_log_min_duration_statement:
  steps:
  - identifier: "{{ prefix }}-cloudsql-postgresql-wrong-log-min-duration-statement"
    command: >- 
      gcloud sql instances create {{ identifier }}
      --availability-type=REGIONAL 
      --region=asia-southeast2 
      --tier=db-g1-small 
      --database-version=POSTGRES_15 
      --enable-point-in-time-recovery
      --root-password=R00tP@ss0rd11@@ 
      --enable-password-policy 
      --password-policy-min-length=12 
      --password-policy-complexity=COMPLEXITY_DEFAULT  
      --backup-location=asia-southeast1 
      --retained-backups-count=10 
      --storage-type=SSD    
      --ssl-mode=ENCRYPTED_ONLY
      --database-flags=log_connections=on,log_disconnections=on,log_min_messages=warning,log_min_error_statement=error,log_min_duration_statement=3600,cloudsql.enable_pgaudit=on,log_error_verbosity=default,log_statement=ddl
    expected_return_code: 1
    expected_stderr: "customConstraints/custom.cloudsqlRequirePostgreSQLDatabaseFlags"
    teardown_command: gcloud sql instances delete {{ idenfifier }}
  markers:
    - cloudsql
    - postgresql
cloudsql_postgresql_instance_no_enable_pgaudit:
  steps:
  - identifier: "{{ prefix }}-cloudsql-postgresql-no-enable-pgaudit"
    command: >- 
      gcloud sql instances create {{ identifier }}
      --availability-type=REGIONAL 
      --region=asia-southeast2 
      --tier=db-g1-small 
      --database-version=POSTGRES_15 
      --enable-point-in-time-recovery
      --root-password=R00tP@ss0rd11@@ 
      --enable-password-policy 
      --password-policy-min-length=12 
      --password-policy-complexity=COMPLEXITY_DEFAULT  
      --backup-location=asia-southeast1 
      --retained-backups-count=10 
      --storage-type=SSD    
      --ssl-mode=ENCRYPTED_ONLY
      --database-flags=log_connections=on,log_disconnections=on,log_min_messages=warning,log_min_error_statement=error,log_min_duration_statement=-1,cloudsql.enable_pgaudit=off,log_error_verbosity=default,log_statement=ddl
    expected_return_code: 1
    expected_stderr: "customConstraints/custom.cloudsqlRequirePostgreSQLDatabaseFlags"
    teardown_command: gcloud sql instances delete {{ idenfifier }}
  markers:
    - cloudsql
    - postgresql
cloudsql_postgresql_instance_wrong_log_error_verbosity:
  steps:
  - identifier: "{{ prefix }}-cloudsql-postgresql-wrong-log-error-verbosity"
    command: >- 
      gcloud sql instances create {{ identifier }}
      --availability-type=REGIONAL 
      --region=asia-southeast2 
      --tier=db-g1-small 
      --database-version=POSTGRES_15 
      --enable-point-in-time-recovery
      --root-password=R00tP@ss0rd11@@ 
      --enable-password-policy 
      --password-policy-min-length=12 
      --password-policy-complexity=COMPLEXITY_DEFAULT  
      --backup-location=asia-southeast1 
      --retained-backups-count=10 
      --storage-type=SSD    
      --ssl-mode=ENCRYPTED_ONLY
      --database-flags=log_connections=on,log_disconnections=on,log_min_messages=warning,log_min_error_statement=error,log_min_duration_statement=-1,cloudsql.enable_pgaudit=on,log_error_verbosity=terse,log_statement=ddl
    expected_return_code: 1
    expected_stderr: "customConstraints/custom.cloudsqlRequirePostgreSQLDatabaseFlags"
    teardown_command: gcloud sql instances delete {{ idenfifier }}
  markers:
    - cloudsql
    - postgresql
cloudsql_postgresql_instance_wrong_log_statement:
  steps:
  - identifier: "{{ prefix }}-cloudsql-postgresql-wrong-log-statement"
    command: >- 
      gcloud sql instances create {{ identifier }}
      --availability-type=REGIONAL 
      --region=asia-southeast2 
      --tier=db-g1-small 
      --database-version=POSTGRES_15 
      --enable-point-in-time-recovery
      --root-password=R00tP@ss0rd11@@ 
      --enable-password-policy 
      --password-policy-min-length=12 
      --password-policy-complexity=COMPLEXITY_DEFAULT  
      --backup-location=asia-southeast1 
      --retained-backups-count=10 
      --storage-type=SSD    
      --ssl-mode=ENCRYPTED_ONLY
      --database-flags=log_connections=on,log_disconnections=on,log_min_messages=warning,log_min_error_statement=error,log_min_duration_statement=-1,cloudsql.enable_pgaudit=on,log_error_verbosity=default,log_statement=none
    expected_return_code: 1
    expected_stderr: "customConstraints/custom.cloudsqlRequirePostgreSQLDatabaseFlags"
    teardown_command: gcloud sql instances delete {{ idenfifier }}
  markers:
    - cloudsql
    - postgresql


