# cloudsql_mysql_instance_allowed:
#   steps:
#   - identifier: "{{ prefix }}-cloudsql-mysql-allowed"
#     command: >- 
#       gcloud sql instances create {{ identifier }}
#       --availability-type=REGIONAL 
#       --region=asia-southeast2 
#       --tier=db-g1-small 
#       --database-version=MYSQL_8_0_37 
#       --enable-bin-log 
#       --root-password=R00tP@ss0rd11@@ 
#       --enable-password-policy 
#       --password-policy-min-length=12 
#       --password-policy-complexity=COMPLEXITY_DEFAULT  
#       --backup-location=asia-southeast1 
#       --retained-backups-count=10 
#       --storage-type=SSD    
#       --ssl-mode ENCRYPTED_ONLY
#       --database-flags=skip_show_database=on,local_infile=off
#     expected_return_code: 0
#     teardown_command: gcloud sql instances delete {{ idenfifier }}
#   markers:
#     - cloudsql
#     - mysql
cloudsql_mysql_instance_no_ssl_mode_encrypted:
  steps:
  - identifier: "{{ prefix }}-cloudsql-mysql-no-ssl-mode"
    command: >- 
      gcloud sql instances create {{ identifier }}
      --availability-type=REGIONAL 
      --region=asia-southeast2 
      --tier=db-g1-small 
      --database-version=MYSQL_8_0_37 
      --enable-bin-log 
      --root-password=R00tP@ss0rd11@@ 
      --enable-password-policy 
      --password-policy-min-length=12 
      --password-policy-complexity=COMPLEXITY_DEFAULT  
      --backup-location=asia-southeast1 
      --retained-backups-count=10 
      --storage-type=SSD      
      --database-flags=local_infile=off,local_infile=off
    expected_return_code: 1
    expected_stderr: "customConstraints/custom.cloudsqlRequireSSLConnection"
    teardown_command: gcloud sql instances delete {{ idenfifier }}
  markers:
    - cloudsql
    - mysql
cloudsql_mysql_instance_no_public_authorized_networks:
  steps:
  - identifier: "{{ prefix }}-cloudsql-mysql-no-public-authorized-networks"
    command: >- 
      gcloud sql instances create {{ identifier }}
      --availability-type=REGIONAL 
      --region=asia-southeast2 
      --tier=db-g1-small 
      --database-version=MYSQL_8_0_37 
      --enable-bin-log 
      --root-password=R00tP@ss0rd11@@ 
      --enable-password-policy 
      --password-policy-min-length=12 
      --password-policy-complexity=COMPLEXITY_DEFAULT  
      --backup-location=asia-southeast1 
      --retained-backups-count=10 
      --storage-type=SSD     
      --database-flags=local_infile=off,local_infile=off
      --ssl-mode ENCRYPTED_ONLY 
      --authorized-networks=0.0.0.0/0
    expected_return_code: 1
    expected_stderr: "customConstraints/custom.cloudsqlDisablePublicAuthorizedNetworks"
    teardown_command: gcloud sql instances delete {{ idenfifier }}
  markers:
    - cloudsql
    - mysql
cloudsql_mysql_instance_no_backup:
  steps:
  - identifier: "{{ prefix }}-cloudsql-mysql-no-backup"
    command: >- 
      gcloud sql instances create {{ identifier }}
      --availability-type=REGIONAL 
      --region=asia-southeast2 
      --tier=db-g1-small 
      --database-version=MYSQL_8_0_37 
      --root-password=R00tP@ss0rd11@@ 
      --enable-password-policy 
      --password-policy-min-length=12 
      --password-policy-complexity=COMPLEXITY_DEFAULT  
      --storage-type=SSD    
      --database-flags=local_infile=off,local_infile=off
      --ssl-mode ENCRYPTED_ONLY
    expected_return_code: 1
    expected_stderr: "customConstraints/custom.cloudsqlRequireAutomatedBackup"
    teardown_command: gcloud sql instances delete {{ idenfifier }}
  markers:
    - cloudsql
    - mysql
cloudsql_mysql_instance_no_skip_show_database_on_flag:
  steps:
  - identifier: "{{ prefix }}-cloudsql-mysql-no-skip-show-database-on-flag"
    command: >- 
      gcloud sql instances create {{ identifier }}
      --availability-type=REGIONAL 
      --region=asia-southeast2 
      --tier=db-g1-small 
      --database-version=MYSQL_8_0_37 
      --enable-bin-log 
      --root-password=R00tP@ss0rd11@@ 
      --enable-password-policy 
      --password-policy-min-length=12 
      --password-policy-complexity=COMPLEXITY_DEFAULT  
      --backup-location=asia-southeast1 
      --retained-backups-count=10 
      --storage-type=SSD    
      --database-flags=local_infile=off,local_infile=off
      --ssl-mode ENCRYPTED_ONLY
      --database-flags=local_infile=off
    expected_return_code: 1
    expected_stderr: "customConstraints/custom.cloudsqlRequireMySQLDatabaseFlags"
    teardown_command: gcloud sql instances delete {{ idenfifier }}
  markers:
    - cloudsql
    - mysql
cloudsql_mysql_instance_no_local_infile_off_flag:
  steps:
  - identifier: "{{ prefix }}-cloudsql-mysql-no-local-infile-off-flag"
    command: >- 
      gcloud sql instances create {{ identifier }}
      --availability-type=REGIONAL 
      --region=asia-southeast2 
      --tier=db-g1-small 
      --database-version=MYSQL_8_0_37 
      --enable-bin-log 
      --root-password=R00tP@ss0rd11@@ 
      --enable-password-policy 
      --password-policy-min-length=12 
      --password-policy-complexity=COMPLEXITY_DEFAULT  
      --backup-location=asia-southeast1 
      --retained-backups-count=10 
      --storage-type=SSD  
      --database-flags=local_infile=off,local_infile=off  
      --ssl-mode ENCRYPTED_ONLY
      --database-flags=skip_show_database=on
    expected_return_code: 1
    expected_stderr: "customConstraints/custom.cloudsqlRequireMySQLDatabaseFlags"
    teardown_command: gcloud sql instances delete {{ idenfifier }}
  markers:
    - cloudsql
    - mysql